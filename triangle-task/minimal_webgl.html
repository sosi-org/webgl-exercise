<!DOCTYPE html>
<html  lang="en">
<head>
    <title>Sohail's WebGL example</title>
    <meta charset="utf-8" />
</head>
<body>
    <canvas id="glcanvas" width="640" height="480">
        Your browser doesn't appear to support the HTML5 <code>&lt;canvas&gt;</code> element.
    </canvas>
    <img  src="./images/painting.gif"/>
    <script type="text/javascript" src=triangle_painter.js></script>

    <script>
    'use strict;'

    // based on
    //      https://github.com/waldyrious/minimal-webgl/blob/gh-pages/index.xhtml
    // texture  code based on:
    //     https://developer.mozilla.org/en-US/docs/Web/API/WebGL_API/Tutorial/Using_textures_in_WebGL

    window.onload = main;


var guy = new OpenglTrianglePainter();

    function make_buffer(gl, textureCoordinates)
    {
        const buffer = gl.createBuffer();
        gl.bindBuffer(gl.ARRAY_BUFFER, buffer);   // Set this buffer as the current one
        //const textureCoordinates = ;
        gl.bufferData(gl.ARRAY_BUFFER, textureCoordinates,  gl.STATIC_DRAW);
        return buffer;
    }

    function main()
    {
        // Get the WebGL context from the canvas
        try {
            var gl = document.getElementById("glcanvas").getContext("webgl");
        } catch(ex) {
            console.log("Unable to initialize WebGL. Your browser may not support it.");
            var gl = null;
            alert('Sorry, no WebGL');
        }


        var texture_ = loadTexture2(gl, './images/painting.gif');
        //var coordDimensions=2;


       guy.brightnessBoost = [0., 0., 0.]; //[0.333/10, 0.666/10, 0.999/10];

       guy.texture = texture_;

       guy.init(gl);
       guy.triangle_vertices = new Float32Array([
           //2 x vertices. Like a queue.
           -0.3,  0.3,
           0.3,  0.2,
           0.1,  -0.1,
       ]);

       guy.texture_coords_array = new Float32Array([
                       0.0,  0.0,
                       1.0,  0.0,
                       1.0,  1.0,
                       0.0,  1.0,
                   ]);

        guy.draw_everything(gl, guy.texture_coords_array, guy.triangle_vertices, guy.brightnessBoost, guy.texture);
        requestAnimationFrame(render);

    }

    function render_rate_limited(time) {
        //guy.triangle_vertices[0] += 0.002;
        guy.triangle_vertices[0] += (Math.random()*2-1)*0.002;
        guy.triangle_vertices[1] += (Math.random()*2-1)*0.002;

        guy.brightnessBoost[0] = Math.sin(time*0.001 * 2)*1 - 0.5;
        if (guy.brightnessBoost[0] < 0.) guy.brightnessBoost[0] = 0.
        guy.draw_everything(guy.gl, guy.texture_coords_array, guy.triangle_vertices, guy.brightnessBoost, guy.texture);

    }

    var accum = 0;
    function render(now) {
        WAIT_MSEC = 10; //1000 / 4;
        if (now - accum > WAIT_MSEC) {
            //console.log("next frame", now);
            //accum = accum + 1000;
            render_rate_limited(now);
            accum = now;
        }
        requestAnimationFrame(render);
    }
    function buildShader(gl, type, source) {
        var sh;
        if (type == "fragment")
            sh = gl.createShader(gl.FRAGMENT_SHADER);
        else if (type == "vertex")
            sh = gl.createShader(gl.VERTEX_SHADER);
        else // Unknown shader type
            return null;
        gl.shaderSource(sh, source);
        gl.compileShader(sh);
        // See if it compiled successfully
        if (!gl.getShaderParameter(sh, gl.COMPILE_STATUS)) {
            console.log("An error occurred compiling the " + type +
            " shader: " + gl.getShaderInfoLog(sh));
            return null;
        } else { return sh; }
    };


    function buildShaderProgram(gl, vertShaderSrc, fragShaderSrc) {

        var prog = gl.createProgram();

        gl.attachShader(prog, buildShader(gl, 'vertex', vertShaderSrc) );
        gl.attachShader(prog, buildShader(gl, 'fragment', fragShaderSrc));

        gl.linkProgram(prog);

        if (!gl.getProgramParameter(prog, gl.LINK_STATUS)) {
            throw "Could not link the shader program!";
        }
        return prog;
    }


    const image = new Image();
    function load_image(url, then)
    {
        //const image = new Image();
        image.onload = then;
        image.src = url;
        console.log("url", url);
    }


    function loadTexture2(gl, url /*, callback2*/) {
        console.log(gl);

        const texture1 = gl.createTexture();
        gl.bindTexture(gl.TEXTURE_2D, texture1);

        const level = 0;
        const internalFormat = gl.RGBA;
        const width = 1;
        const height = 1;
        const border = 0;
        const srcFormat = gl.RGBA;
        const srcType = gl.UNSIGNED_BYTE;

        const preview_single_pixel = new Uint8Array([255, 0, 0, 255]);  // opaque blue
        gl.texImage2D(gl.TEXTURE_2D, level, internalFormat,
                      width, height, border, srcFormat, srcType,
                      preview_single_pixel);


        load_image(url, function() {
            console.log(gl);

            gl.bindTexture(gl.TEXTURE_2D, texture1);
            gl.texImage2D(gl.TEXTURE_2D, level, internalFormat,
                    srcFormat, srcType, image);

            if (isPowerOf2(image.width) && isPowerOf2(image.height)) {
               gl.generateMipmap(gl.TEXTURE_2D);
            } else {
               // Turn off mip-mapping
               gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);
               gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);
               gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR);
            }
            console.log("Image loaded. Now:",texture1);

        });
        return texture1;
    }



    function isPowerOf2(value) {
      return (value & (value - 1)) == 0;
    }

    //function drawObject(gl, shaderProgram, coordDimensions, brightnessBoost, vertexCoords_array) {
    //}

    /*
    // Note!!!: You'd have to change this code to delete the resources YOU created.
    gl.deleteTexture(someTexture);
    gl.deleteTexture(someOtherTexture);
    gl.deleteBuffer(someBuffer);
    gl.deleteBuffer(someOtherBuffer);
    gl.deleteRenderbuffer(someRenderbuffer);
    gl.deleteFramebuffer(someFramebuffer);
    */


    </script>
</body>
</html>
